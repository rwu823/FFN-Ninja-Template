"use strict";require("colors");var gulp=require("gulp"),path=require("path"),http=require("http"),fs=require("fs"),domain=require("domain"),server=http.createServer(),request=require("request"),io,nopt=require("nopt"),cheerio=require("cheerio"),open=require("open"),_=require("lodash"),param=nopt({help:Boolean},{h:"-help"}),FFN=module.exports=function(){function e(e){var t=this;t.project=e.project||"",t.site=e.site||"ffadult",t.lang=e.lang||"all"}var t=function(o,n){var i=path.basename(n).replace(/\.\w*$/,""),r=fs.readFileSync(n,"utf-8"),l=[].slice.call(arguments);o.site=o.site.toLowerCase(),o.lang=o.lang.toLowerCase(),e.log("Save Local:",n),io.sockets.emit("ninja-template",{act:"save-local",file:n,site:o.site,lang:o.lang});request.post("http://"+e.host+":"+e.port+"/cgi-bin/admin/dictionary/editor.cgi",function(r,s){return r||/^(401|500)$/.test(s.statusCode)?(e.log("Error: save local, waiting for try again ..."),io.sockets.emit("ninja-template",{act:"error-save-local",file:n,statusCode:s.statusCode}),setTimeout(function(){t.apply(null,l)},1e4)):void a(o,i)}).auth(e.developer,e.password,!1).form({root:1,data:r,site:"all"===o.site?"ffadult":o.site,lang:"all"===o.lang?"english":o.lang,keyword:i,action:"Save local"})},a=function(t,o){var n=t.site+"-"+t.lang,i=[].slice.call(arguments);e.log("Publish to sandbox( "+t.site+"-"+t.lang+"):",o),io.sockets.emit("ninja-template",{act:"publish",file:o,site:t.site,lang:t.lang}),request.get("http://"+e.host+":"+e.port+"/cgi-bin/admin/dictionary/pushtolive.cgi?version=devel&"+n+"=1&local=1&submit=1&keyword="+o+"&compiled=-1",function(t,o){return t||/^(401|500)$/.test(o.statusCode)?(e.log("Error: publish, waiting for try again ..."),io.sockets.emit("ninja-template",{act:"error-publish",statusCode:o.statusCode}),setTimeout(function(){a.apply(null,i)},1e4)):(e.log("Done"),void io.sockets.emit("ninja-template",{act:"reload"}))}).auth(e.developer,e.password,!1)};return e.set=function(t){e.developer=t.developer||"",e.host=(t.host||"dev25")+".friendfinderinc.com",e.port=t.port||"8080",e.password=t.password||"***"},e.log=function(){var e=["[Ninja-Template]".green].concat([].slice.call(arguments));console.log.apply(console,e)},e.param=param,e.cmd=param.argv.cooked[0],e.commit=function(){if(param.help)return e.log("help:","commit [options]"),console.log("	-t, -template [require] \n		Template name\n"),console.log("	-m, -comment [require] \n		Commit comment, format is: #project-number your comment\n		#project-number also dir name on templates/[dir]\n"),console.log("	-s, -site [option]  \n		Site name, default is: ffadult\n"),void console.log("	-l, -lang [option]  \n		Language, default is: english\n");if(param=nopt({template:[String,""],comment:[String,""],site:[String,"ffadult"],lang:[String,"english"]},{t:["-template"],m:"-comment",s:["-site"],l:["-lang"]}),param=_.extend({site:"ffadult",lang:"english"},param),!param.template)return e.log("Please set template name.");if(!param.comment)return e.log("Please write your comment.");for(var t,a,o=[".htm",".html",".js",".css"],n="http://"+e.host+":"+e.port+"/cgi-bin/admin/dictionary/editor.cgi",i=param.comment.split(" ")[0],r=0;(a=o[r])&&(t=path.join("./templates",i,param.template+a),!fs.existsSync(t));r++);if(!t)return e.log("Template does not exist:",param.template);e.log("Read file:",t);var l=fs.readFileSync(t,{encoding:"UTF-8"});e.log("Commit to DB:",param.comment),request.post(n,function(t){if(t)return e.log(t);var a="http://"+e.host+":"+e.port+"/cgi-bin/admin/dictionary/history.cgi?action=Load%20local&site="+param.site+"&lang="+param.lang+"&keyword="+param.template;return open(a),e.log("Your comment already committed!!\n",a),process.exit()}).form({root:1,data:l,site:param.site,lang:param.lang,keyword:param.template,commitaction:"Commit to DB",commmit_comment:param.comment}).auth(e.developer,e.password,!1)},e.save=function(){if(param.help)return e.log("help:","save [options]"),console.log("	-t, -template [require] \n		Template name\n"),console.log("	-s, -site [option]  \n		Site name, default is: ffadult\n"),console.log("	-l, -lang [option]  \n		Language, default is: english\n"),console.log("	-d, -dir [option]  \n		Directory path, default is: templates/.save/\n"),void console.log("	-sb, --sandbox [option]  \n		Save sandbox template, default is: DB\n");if(param=nopt({template:[String,""],site:[String,"ffadult"],lang:[String,"english"],dir:[String,""],sandbox:Boolean},{t:["-template"],s:["-site"],l:["-lang"],d:["-dir"],sb:"sandbox"}),param=_.extend({site:"ffadult",lang:"english"},param),!param.template)return e.log("Please set template name");param.dir=param.dir||".save";var t=param.sb?"action=Load%20local":"",a="http://"+e.host+":"+e.port+"/cgi-bin/admin/dictionary/editor.cgi?"+t+"&site="+param.site+"&lang="+param.lang+"&keyword="+param.template,o=".htm";/^(css|javascript)[-_]/.test(param.template)&&(o={css:".css",javascript:".js"}[RegExp.$1]),e.log("Waiting for save:",param.template,"("+param.site+"-"+param.lang+")",param.sb?"-sandbox":"");request.get(a,function(t,a,n){t&&e.log(t);var i=cheerio.load(n),r=i("#advedit").val();if(void 0===r)return e.log("Cannot find template:",param.template),process.exit();var l=path.join("templates",param.dir),s=path.join(l,param.template+o);fs.existsSync(l)||fs.mkdirSync(l),fs.writeFile(s,r,function(t){return t&&e.log(t),e.log("Save file to:",s),process.exit()})}).auth(e.developer,e.password,!1)},e.deftag=function(){if(param.help)return e.log("help:","deftag [options]"),console.log("	-n, -name [option] \n		Search deftag variate name\n"),void console.log("	-t, -text [option]  \n		Search deftag text\n");param=nopt({name:[String,""],text:[String,""]},{n:["-name"],t:["-text"]}),e.log("Waiting for search deftag...");var t,a="https://admin.friendfinderinc.com/cgi-bin/admin/dictionary/deftags.cgi?";t=param.name?request.get(a+"&page=edit_deftag_rows&defnames="+param.name,function(t,a,o){t&&e.log(t);var n=cheerio.load(o),i=n("textarea").val();e.log('Deftag "'+param.name+'" is: \n'+i)}):request.get(a+"&action_find_by_text=by+text&pattern=^"+param.text+"$",function(t,a,o){t&&e.log(t);var n=cheerio.load(o),i=n("a.deftag"),r=[];i.each(function(){r.push(n(this).text())}),e.log('Text "'+param.text+'" have deftags: \n'+r.join("\n"))}),t.auth(e.developer,e.password,!1)},e.pu=e.publish=function(){},e.lo=e.login=function(){return param.help?(e.log("help:","lo login [options]"),console.log("	-u, -user [require] \n		Login with handle name\n"),void console.log("	-s, -site [option] \n		site, default is ffadult\n")):(param=nopt({user:[String,""],site:[String,""]},{u:["-user"],s:["-site"]}),param=_.extend({site:"ffadult"},param),void request.get("https://admin.friendfinderinc.com/cgi-bin/admin/lookup.cgi?site="+param.site+"&handle="+param.user,function(e,t,a){var o=cheerio.load(a);open(o('a[href*="login.cgi?action=login"]').attr("href"))}).auth(e.developer,e.password,!1))},e.lookup=function(){if(param.help)return e.log("help:","lookup [options]"),console.log("	-u, -user [require] \n		Lookup handle name\n"),console.log("	-s, -site [option] \n		site, default is ffadult\n"),void console.log("	-e, -email [option] \n		Search internal accounts, Default is false\n");param=nopt({user:[String,""],site:[String,""],email:Boolean},{u:["-user"],s:["-site"],e:"-email"}),param=_.extend({site:"ffadult"},param);var t="&"+(param.email?"email="+param.user+"@ffn.com":"handle="+param.user);open("https://admin.friendfinderinc.com/cgi-bin/admin/lookup.cgi?site="+param.site+t)},e.prototype.go=function(){var a=this,o=path.join("templates",a.project),n=fs.readdirSync(o).map(function(e){return e.replace(/\.\w*$/,"")}).join("\n");e.log("Start Project: ("+a.site+"-",a.lang+")",o+"\n"+n),gulp.watch(path.join(o,"*"),function(e){"changed"===e.type&&t(a,e.path)})},e}();process.on("uncaughtException",function(e){FFN.log("uncaughtException:",e)});var isCMD="function"==typeof FFN[FFN.cmd];isCMD||(io=require("socket.io").listen(server),server.listen(35729),io.set("log level",1));