"use strict";require("colors");var gulp=require("gulp"),path=require("path"),http=require("http"),server=http.createServer(),io=require("socket.io").listen(server),request=require("request"),domain=require("domain"),fs=require("fs"),logNinja=function(){var e=["[Ninja-Template]".green].concat([].slice.call(arguments));console.log.apply(console,e)};server.listen(35729),io.set("log level",1);var FFN=module.exports=function(){function e(e){var t=this;t.project=e.project||"",t.site=e.site||"ffadult",t.lang=e.lang||"english"}var t=function(a,i){var r=path.basename(i).replace(/\.\w*$/,""),n=fs.readFileSync(i,"utf-8"),s=[].slice.call(arguments);logNinja("Save Local:",i),io.sockets.emit("ninja-template",{act:"save-local",file:i,site:a.site,lang:a.lang});request.post("http://"+e.host+":"+e.port+"/cgi-bin/admin/dictionary/editor.cgi",function(e,n){return e||/^(401|500)$/.test(n.statusCode)?(logNinja("Error: save local, waiting for try again ..."),io.sockets.emit("ninja-template",{act:"error-save-local",file:i,statusCode:n.statusCode}),setTimeout(function(){t.apply(null,s)},1e4)):void o(a,r)}).auth(e.developer,e.password,!1).form({root:1,data:n,site:a.site,lang:a.lang,keyword:r,action:"Save local"})},o=function(t,a){var i=t.site+"-"+t.lang,r=[].slice.call(arguments);logNinja("Publish to sandbox:",a),io.sockets.emit("ninja-template",{act:"publish"}),request.get("http://"+e.host+":"+e.port+"/cgi-bin/admin/dictionary/pushtolive.cgi?version=devel&"+i+"=1&local=1&submit=1&keyword="+a+"&compiled=-1",function(e,t){return e||/^(401|500)$/.test(t.statusCode)?(logNinja("Error: publish, waiting for try again ..."),io.sockets.emit("ninja-template",{act:"error-publish",statusCode:t.statusCode}),setTimeout(function(){o.apply(null,r)},1e4)):(logNinja("Done"),void io.sockets.emit("ninja-template",{act:"reload"}))}).auth(e.developer,e.password,!1)};return e.set=function(t){e.developer=t.developer||"",e.host=(t.host||"dev25")+".friendfinderinc.com",e.port=t.port||"8080",e.password=t.password||"***"},e.prototype.go=function(){var e=this,o=path.join("templates",e.project),a=fs.readdirSync(o).map(function(e){return e.replace(/\.\w*$/,"")}).join("\n");logNinja("Start Project:",o+"\n",a),gulp.watch(path.join(o,"*"),function(o){"changed"===o.type&&t(e,o.path)})},e}();