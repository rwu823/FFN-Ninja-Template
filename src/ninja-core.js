"use strict";require("colors");var gulp=require("gulp"),path=require("path"),http=require("http"),fs=require("fs"),domain=require("domain"),server=http.createServer(),io=require("socket.io").listen(server),request=require("request"),nopt=require("nopt"),cheerio=require("cheerio"),open=require("open"),param=nopt({site:[String,"ffadult"],lang:[String,"english"],template:[String,""],dir:[String,""],help:Boolean,comment:[String,""]},{s:["-site"],l:["-lang"],t:["-template"],d:["-dir"],h:["-help"],m:"-comment"});server.listen(35729),io.set("log level",1),param.site=param.site||"ffadult",param.lang=param.lang||"english";var FFN=module.exports=function(){function e(e){var t=this;t.project=e.project||"",t.site=e.site||"ffadult",t.lang=e.lang||"english"}var t=function(o,r){var i=path.basename(r).replace(/\.\w*$/,""),n=fs.readFileSync(r,"utf-8"),l=[].slice.call(arguments);e.log("Save Local:",r),io.sockets.emit("ninja-template",{act:"save-local",file:r,site:o.site,lang:o.lang});request.post("http://"+e.host+":"+e.port+"/cgi-bin/admin/dictionary/editor.cgi",function(n,s){return n||/^(401|500)$/.test(s.statusCode)?(e.log("Error: save local, waiting for try again ..."),io.sockets.emit("ninja-template",{act:"error-save-local",file:r,statusCode:s.statusCode}),setTimeout(function(){t.apply(null,l)},1e4)):void a(o,i)}).auth(e.developer,e.password,!1).form({root:1,data:n,site:o.site,lang:o.lang,keyword:i,action:"Save local"})},a=function(t,o){var r=t.site+"-"+t.lang,i=[].slice.call(arguments);e.log("Publish to sandbox( "+t.site+"-"+t.lang+"):",o),io.sockets.emit("ninja-template",{act:"publish",file:o,site:t.site,lang:t.lang}),request.get("http://"+e.host+":"+e.port+"/cgi-bin/admin/dictionary/pushtolive.cgi?version=devel&"+r+"=1&local=1&submit=1&keyword="+o+"&compiled=-1",function(t,o){return t||/^(401|500)$/.test(o.statusCode)?(e.log("Error: publish, waiting for try again ..."),io.sockets.emit("ninja-template",{act:"error-publish",statusCode:o.statusCode}),setTimeout(function(){a.apply(null,i)},1e4)):(e.log("Done"),void io.sockets.emit("ninja-template",{act:"reload"}))}).auth(e.developer,e.password,!1)};return e.set=function(t){e.developer=t.developer||"",e.host=(t.host||"dev25")+".friendfinderinc.com",e.port=t.port||"8080",e.password=t.password||"***"},e.log=function(){var e=["[Ninja-Template]".green].concat([].slice.call(arguments));console.log.apply(console,e)},e.param=param,e.cmd=param.argv.cooked[0],e.commit=function(){if(param.help)return e.log("help:","commit [options]"),console.log("	-d, -dir [require] \n		project dir, also is [project name] of comment\n"),console.log("	-m, -commnt [require] \n		commit comment\n"),console.log("	-t, -template [require] \n		template name\n"),console.log("	-s, -site [option]  \n		site name, default is: ffadult\n"),console.log("	-l, -lang [option]  \n		language, default is: english\n"),process.exit();if(!param.template)return e.log("Please set template name.");if(!param.comment)return e.log("Please write your comment.");for(var t,a,o=[".htm",".html",".js",".css"],r="http://"+e.host+":"+e.port+"/cgi-bin/admin/dictionary/editor.cgi",i=0;(a=o[i])&&(t=path.join("./templates",param.dir,param.template+a),!fs.existsSync(t));i++);if(!t)return e.log("Template does not exist:",param.template);var n=fs.readFileSync(t,{encoding:"UTF-8"});e.log("Commit to DB:",param.dir+" - "+param.comment),request.post(r,function(t,a){if(200===a.statusCode){var o="http://"+e.host+":"+e.port+"/cgi-bin/admin/dictionary/history.cgi?action=Load%20local&site="+param.site+"&lang="+param.lang+"&keyword="+param.template;return open(o),e.log("Your comment already committed!!\n",o),process.exit()}}).form({root:1,data:n,site:param.site,lang:param.lang,keyword:param.template,commitaction:"Commit to DB",commmit_comment:param.dir+" - "+param.comment}).auth(e.developer,e.password,!1)},e.save=function(){if(param.help)return e.log("help:","save [options]"),console.log("	-t, -template [require] \n		template name\n"),console.log("	-s, -site [option]  \n		site name, default is: ffadult\n"),console.log("	-l, -lang [option]  \n		language, default is: english\n"),console.log("	-d, -dir [option]  \n		directory path, default is: templates/.save/\n"),console.log("	-sb, --sandbox [option]  \n		save sandbox template, default is: DB\n"),process.exit();if(!param.template)return e.log("Please set template name");param.dir=param.dir||".save";var t=param.sb?"action=Load%20local":"",a="http://"+e.host+":"+e.port+"/cgi-bin/admin/dictionary/editor.cgi?"+t+"&site="+param.site+"&lang="+param.lang+"&keyword="+param.template;e.log("Waiting for save:",param.template,"("+param.site+"-"+param.lang+")",param.sb?"-sandbox":"");request.get(a,function(t,a,o){t&&e.log(t);var r=cheerio.load(o),i=r("#advedit").val();if(void 0===i)return e.log("Cannot find template:",param.template),process.exit();var n="templates/"+param.dir,l=path.join(n,param.template);fs.existsSync(n)||fs.mkdirSync(n),fs.writeFile(l,i,function(t){return t&&e.log(t),e.log("Save file to:",l),process.exit()})}).auth(e.developer,e.password,!1)},e.prototype.go=function(){var a=this,o=path.join("templates",a.project),r=fs.readdirSync(o).map(function(e){return e.replace(/\.\w*$/,"")}).join("\n");e.log("Start Project: ("+a.site+"-",a.lang+")",o+"\n"+r),gulp.watch(path.join(o,"*"),function(e){"changed"===e.type&&t(a,e.path)})},e}();process.on("uncaughtException",function(e){FFN.log("uncaughtException:",e)});